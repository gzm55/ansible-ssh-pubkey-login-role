galaxy_info:
  author: James Z.M. Gao
  description: Role for copying local ssh public keys to managed hosts.

  license: BSD

  min_ansible_version: 2.2

  platforms:
  - name: GenericBSD
    versions:
    - any
  - name: GenericLinux
    versions:
    - any
  - name: Windows
    versions:
    - all
  - name: GenericUNIX
    versions:
    - any

  galaxy_tags: [system, networking]

allow_duplicates: no
dependencies:
- role: gzm55.require_implicity_localhost
- role: gzm55.local_ansible_config
  config_key: ssh_connection/ssh_executable

- role: gzm55.require_local_command
  only_check: True
  command: [ ssh-add, ssh-keygen ]

- role: gzm55.require_local_command
  command:
  - cat
  - >
    {{ ansible_play_hosts_all
       | map('extract', hostvars)
       | selectattr('ansible_ssh_executable', 'defined')
       | map(attribute='ansible_ssh_executable')
       | list
       | union(( ansible_play_hosts_all
                 | map('extract', hostvars)
                 | rejectattr('ansible_ssh_executable', 'defined')
                 | list
                 | length == 0 )
               | ternary([],
                         [lookup('env', 'ANSIBLE_SSH_EXECUTABLE')
                          | d(local_ansible_config['ssh_connection/ssh_executable'], True)
                          | d('ssh', True)]
                 )
         )
    }}
